{
    # Local/staging defaults – keep HTTP listeners alive without hitting ACME
    auto_https disable_redirects
    http_port 80
    https_port 443
}

# Dev/Staging · shared snippets for static bundles
(site_static) {
    tls internal
    root * /srv/site
    encode zstd gzip
    try_files {path} {path}/ /index.html
    file_server
}

(codex_static) {
    tls internal
    root * /srv/codex
    encode zstd gzip
    try_files {path} {path}/ /index.html
    file_server
}

# Dev/Staging · main landing hosts
impious.test {
    import site_static
}

imperiumsolis.test {
    import site_static
}

www.imperiumsolis.test {
    import site_static
}

# Dev/Staging · legacy www host stays redirected to impious.test
www.impious.test {
    tls internal
    redir https://impious.test{uri}
}

# Dev/Staging · codex placeholder domains mirror prod routing
codex.impious.test {
    import codex_static
}

codex.imperiumsolis.test {
    import codex_static
}

# Dev/Staging · future multiplayer API stub (override via GAME_API_ENABLED=1 + --profile game)
game.imperiumsolis.test, game.impious.test {
    tls internal
    @game_api_live expression {env.GAME_API_ENABLED} == "1"

    handle @game_api_live {
        reverse_proxy game-api:3000 {
            header_up Host {http.request.host}
            header_up X-Forwarded-Proto {http.request.scheme}
            header_up X-Real-IP {http.request.remote}
        }
    }

    handle {
        respond 200 {
            body "{\"status\":\"unavailable\",\"message\":\"Game API placeholder (dev).\"}"
            close
        }
    }
}
