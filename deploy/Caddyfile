{
    email {$CADDY_ADMIN_EMAIL}
}

imperiumsolis.org, www.imperiumsolis.org {
    root * /srv/site
    encode zstd gzip
    try_files {path} {path}/ /index.html
    file_server

    @health path /healthz
    respond @health 200 {
        body "ok"
        close
    }
}

codex.imperiumsolis.org, codex.imperiumsolis.com, codex.impious.io {
    root * /srv/codex
    encode zstd gzip
    try_files {path} {path}/ /index.html
    file_server

    @health path /healthz
    respond @health 200 {
        body "ok"
        close
    }
}

game.imperiumsolis.com {
    @game_api_live expression {env.GAME_API_ENABLED} == "1"

    handle @game_api_live {
        reverse_proxy game-api:3000 {
            header_up Host {http.request.host}
            header_up X-Forwarded-Proto {http.request.scheme}
            header_up X-Real-IP {http.request.remote}

            transport http {
                compression off
                read_buffer 0
            }
        }
    }

    handle {
        respond 200 {
            body "{\"status\":\"unavailable\",\"message\":\"Imperium Solis multiplayer API is not deployed yet.\"}"
            close
        }
    }
}

http://imperiumsolis.org, http://www.imperiumsolis.org {
    redir https://imperiumsolis.org{uri}
}

http://codex.imperiumsolis.org, http://codex.imperiumsolis.com, http://codex.impious.io {
    redir https://{host}{uri}
}

http://game.imperiumsolis.com {
    redir https://game.imperiumsolis.com{uri}
}
