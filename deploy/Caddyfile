{
    # Global options
}

# Main Site
{$SITE_ADDRESS} {
    root * /srv/site

    log {
        output stdout
        format console
    }

    encode zstd gzip

    route {
        # --- API Routes MUST run before file_server ---
        @enlist path /enlist*
        reverse_proxy @enlist enlist-api:3000 {
            header_up X-Forwarded-For {remote_host}
        }

        @health path /healthz
        reverse_proxy @health enlist-api:3000

        # --- Static site fallback ---
        try_files {path} {path}/ /index.html
        file_server
    }

    tls {$TLS_OPTS}
}


# WWW Redirect
{$WWW_ADDRESS} {
    redir https://{$SITE_ADDRESS}{uri}
}

# Future Game API Stub
{$GAME_ADDRESS} {
    tls {$TLS_OPTS}
    respond "game-api stubbed" 200
}
