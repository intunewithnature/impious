# IMPIOUS REPO — FULL MAIN BRANCH AUDIT (2025-11-21)

## 1. Repo Structure
- **Root docs** (`README.md`, `README-dev.md`) define the canonical stack location (`/opt/impious/deploy`), describe Caddy + future `game-api`, and spell out dev/prod branches (see `README.md` lines 5-65).
- **`deploy/`** contains all runtime config: `Caddyfile`, `Caddyfile.dev`, `docker-compose.yml`, `docker-compose.dev.yml`, `Dockerfile.caddy`, and a deploy-specific README (see `deploy/README.md`).
- **`site/`** holds the Vite/TypeScript landing page (`package.json`, `vite.config.ts`, `src/`, `styles/`) plus the committed build output in `site/public/`.
- **`.github/workflows/`** includes `dev-ci.yml`, `main-build.yml`, and `cursor-code-review.yml`.
- **`game-api/`** is referenced in documentation but not present yet; compose/Caddy stubs remain commented.

## 2. Caddy Architecture
- **Production config** (`deploy/Caddyfile`) serves `impious.io`, redirects `www.impious.io`, and keeps `game.impious.io` reverse proxy commented until the service exists.
- TLS relies on Caddy’s automatic HTTPS with HTTP/3 support via port 443/udp (once compose exposes it correctly).
- **Dev config** (`deploy/Caddyfile.dev`) currently references `imperiumsolis.org`, lacks `auto_https off`, and should switch to `impious.test` + `tls internal` per README guidance.
- Caddy runs inside Docker, mounting `/etc/caddy/Caddyfile` and `/srv/site` from the host via compose volumes.

## 3. Docker Architecture
- Only one service (`caddy`) is defined in both compose files.
  - `deploy/docker-compose.yml` (intended prod) mistakenly mounts `Caddyfile.dev`, names the container `caddy-dev`, and reuses dev volumes (`caddy_data_dev`, `caddy_config_dev`).
  - `deploy/docker-compose.dev.yml` duplicates the same definition and still binds host ports 80/443, so dev conflicts with prod.
- No `game-api` service entries yet; they remain TODO per documentation.
- `deploy/Dockerfile.caddy` builds a GHCR-ready image bundling `deploy/Caddyfile` + `site/public`.

## 4. Frontend Build Pipeline
- `site/package.json` scripts: `dev`, `build`, `preview`, `check`.
- `vite.config.ts` outputs to `site/public/` with hashed assets and uses `site/static/` as the public dir.
- Entry point `site/src/main.ts` imports modules under `site/src/modules/` for parallax, motion, observer, and Three.js scene work.
- `site/public/index.html` is committed, references hashed assets (`/assets/index-CRqll0Xp.js`), and currently contains a `<!-- DEV-STAGING-MARKER: imperiumsolis-dev -->` comment that should be removed/replaced for prod builds.

## 5. CI/CD Review
- **`dev-ci.yml`**: on `dev` branch pushes/PRs, runs `docker compose config` (prod + overrides), validates both Caddyfiles using the official `caddy:2-alpine` image, and builds `deploy/Dockerfile.caddy` without pushing.
- **`main-build.yml`**: on `main` pushes/tags, uses Buildx to build/push `ghcr.io/${owner}/impious-caddy` with tags `${sha}` and `latest`. Conditionally builds `impious-game-api` if `game-api/Dockerfile` exists.
- **`cursor-code-review.yml`**: runs Cursor’s reviewer bot on PRs (non-draft) to post findings.
- No workflow yet ensures `site/public` matches `npm run build`; future automation should check for dirty assets.

## 6. NixHQ Integration Check
- Docs expect the repo to live at `/opt/impious/deploy`, with compose commands run from `/opt/impious/deploy/deploy`.
- Production should use `deploy/docker-compose.yml` + `deploy/Caddyfile`; staging should use `docker-compose.yml` + `docker-compose.dev.yml` with `Caddyfile.dev`.
- Current files violate these assumptions (prod compose points at dev config, dev compose doesn’t remap ports). Nix services consuming unmodified files will boot the wrong domains, so fixes must land before NixHQ pulls.

## 7. Problems Found & Fixes
1. **Prod compose uses dev config**  
   - File: `deploy/docker-compose.yml` (entire file).  
   - Issue: Mounts `Caddyfile.dev`, uses dev volumes/container names, so TLS targets wrong hosts.  
   - Fix: Replace with:
     ```yaml
     services:
       caddy:
         image: caddy:2-alpine
         container_name: caddy-prod
         restart: unless-stopped
         working_dir: /srv/site
         ports:
           - "80:80"
           - "443:443"
         volumes:
           - ./Caddyfile:/etc/caddy/Caddyfile:ro
           - ../site/public:/srv/site:ro
           - caddy_data:/data
           - caddy_config:/config

     volumes:
       caddy_data:
       caddy_config:
     ```
   - Testing: `docker compose -f deploy/docker-compose.yml config`; redeploy on prod host.
   - NixHQ: Update production service/unit to expect `caddy-prod` and new volumes.

2. **Dev compose still binds 80/443**  
   - File: `deploy/docker-compose.dev.yml`.  
   - Issue: Dev/staging collides with prod ports; doesn’t act as an override.  
   - Fix:
     ```yaml
     services:
       caddy:
         image: caddy:2-alpine
         container_name: caddy-staging
         restart: unless-stopped
         working_dir: /srv/site
         ports:
           - "8080:80"
           - "8443:443"
         volumes:
           - ./Caddyfile.dev:/etc/caddy/Caddyfile:ro
           - ../site/public:/srv/site:ro
           - caddy_data_dev:/data
           - caddy_config_dev:/config

     volumes:
       caddy_data_dev:
       caddy_config_dev:
     ```
   - Testing: `docker compose -f deploy/docker-compose.yml -f deploy/docker-compose.dev.yml config`; curl `https://impious.test:8443`.
   - NixHQ: ensure firewall rules and compose invocation include both files.

3. **Dev Caddyfile targets wrong domain + ACME**  
   - File: `deploy/Caddyfile.dev`.  
   - Issue: References `imperiumsolis.org`, lacks `auto_https off` & `tls internal`, so staging fails ACME.  
   - Fix:
     ```caddy
     {
         email you@example.com
         auto_https off
         admin off
     }

     impious.test, www.impious.test {
         tls internal
         root * /srv/site
         encode zstd gzip
         try_files {path} {path}/ /index.html
         file_server
     }

     # game.impious.test {
     #     reverse_proxy game-api:3000
     # }
     ```
   - Testing: `docker run --rm -v $PWD/deploy:/work caddy:2-alpine caddy validate --config /work/Caddyfile.dev`.
   - NixHQ: distribute internal CA to staging hosts if necessary.

4. **Prod HTML leaks dev marker**  
   - File: `site/public/index.html`.  
   - Issue: Contains `<!-- DEV-STAGING-MARKER: imperiumsolis-dev -->`; should be production-agnostic.  
   - Fix: remove or replace with neutral marker, e.g., `<!-- BUILD-MARKER: impious-main -->`, then `npm run build`.  
   - Testing: Rebuild and verify marker via `curl` output.
   - NixHQ: none; redeploy updated static files.

## 8. Suggested Improvements
- Bootstrap `game-api/` skeleton so compose/Caddy stubs become testable.
- Add healthchecks and pin `caddy:2` image digests.
- Extend CI to run `npm ci && npm run build` and fail when `site/public` diff appears.
- Document `.test` host entries in `deploy/README.md`.
- Automate deploy triggers (GitOps or remote hook) once secrets available.

## 9. Final Assessment
Stack is intentionally simple (Caddy serving static assets) but production/dev separation regressed—prod points at the dev config, dev ports collide, and dev Caddyfile references another project. Fixes above realign the repo with the documented expectations so NixHQ can safely manage prod vs staging stacks.

---

## Pull Request Plan
- **Commits**
  1. `fix: restore production compose separation and dev ports`
  2. `chore: align dev caddy domains and clean build marker`

- **Testing**
  - `docker compose -f deploy/docker-compose.yml config`
  - `docker compose -f deploy/docker-compose.yml -f deploy/docker-compose.dev.yml config`
  - `docker run --rm -v $PWD/deploy:/work caddy:2-alpine caddy validate --config /work/Caddyfile.dev`
  - `cd site && npm ci && npm run build`

- **Deployment Checklist (Ampheat)**
  1. Build landing assets (`cd site && npm run build`).
  2. `cd deploy && docker compose pull`.
  3. `docker compose up -d --remove-orphans` (prod).
  4. `docker compose -f docker-compose.yml -f docker-compose.dev.yml up -d` (staging).
  5. Verify `https://impious.io` and `https://impious.test:8443`.

- **NixHQ Updates**
  - Point prod service at updated `deploy/docker-compose.yml`.
  - Ensure staging service composes both files and exposes 8080/8443.
  - Trust internal CA for `.test` domains if needed.
